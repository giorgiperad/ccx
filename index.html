<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>კრიპტო კოლექტივი X</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Sora:wght@700&display=swap" rel="stylesheet">
    <!-- Your existing CSS remains unchanged -->
</head>
<body>
    <header>
        <h1>CRYPTO COLLECTIVE <span class="highlight-x">X</span></h1>
    </header>
    
    <div class="fear-greed-container">
        <h2>ბაზრის განწყობა</h2>
        <div class="gauge-row">
            <div class="gauge-column">
                <div class="gauge-circle" id="fear_commands-circle">
                    <div class="gauge-bg"></div>
                    <span id="fear-greed-value" class="gauge-value">ჩატვირთვა...</span>
                </div>
                <span id="fear-greed-classification" class="fear-greed-classification">ჩატვირთვა...</span>
            </div>
            <div class="gauge-column">
                <div class="gauge-circle" id="btc-dominance-circle">
                    <div class="gauge-bg"></div>
                    <span id="btc-dominance-value" class="gauge-value">ჩატვირთვა...</span>
                </div>
                <span class="gauge-label">BTC დომინაცია</span>
            </div>
            <div class="gauge-column">
                <div class="gauge-circle" id="alt-season-circle">
                    <div class="gauge-bg"></div>
                    <span id="alt-season-value" class="gauge-value">ჩატვირთვა...</span>
                </div>
                <span class="gauge-label">ალტ სეზონის ინდექსი</span>
            </div>
        </div>
    </div>

    <div class="prices-container">
        <h2>კრიპტოვალუტის ფასები</h2>
        <div id="price-list"></div>
    </div>

    <script>
        async function fetchWithRetry(url, retries = 3, delay = 2000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Fetch failed: ${url}`, response.status, errorText);
                        if (response.status === 429 && i < retries - 1) {
                            console.log(`Rate limited, retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`Fetch failed: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.log(`Attempt ${i + 1} failed, retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function fetchData() {
            try {
                // Fear and Greed Index (unchanged)
                const fngData = await fetchWithRetry('https://api.alternative.me/fng/?limit=1');
                const todayValue = fngData.data[0].value;
                const classification = fngData.data[0].value_classification;
                document.getElementById('fear-greed-value').textContent = todayValue;
                const todayAngle = (todayValue / 100) * 360;
                document.getElementById('fear-greed-circle').style.background = `conic-gradient(
                    #ff5277 0deg,
                    #4c78ff ${todayAngle}deg,
                    #2c334d ${todayAngle}deg,
                    #2c334d 360deg
                )`;
                const translations = {
                    "Extreme Fear": "უკიდურესი შიში",
                    "Fear": "შიში",
                    "Neutral": "ნეიტრალური",
                    "Greed": "სიხარბე",
                    "Extreme Greed": "უკიდურესი სიხარბე"
                };
                document.getElementById('fear-greed-classification').textContent = 
                    translations[classification] || classification;

                // CoinMarketCap API Key (replace with your own free API key)
                const apiKey = 'ca1e4d8c-9947-4a35-80ff-a8cbf0454913';
                const headers = { 'X-CMC_PRO_API_KEY': apiKey };

                // Fetch global metrics for BTC dominance
                const globalData = await fetchWithRetry(
                    'https://pro-api.coinmarketcap.com/v1/global-metrics/quotes/latest',
                    3,
                    2000,
                    { headers }
                );
                const btcDominance = globalData.data.btc_dominance.toFixed(1);
                document.getElementById('btc-dominance-value').textContent = `${btcDominance}%`;
                const btcAngle = (btcDominance / 100) * 360;
                document.getElementById('btc-dominance-circle').style.background = `conic-gradient(
                    #ff5277 0deg,
                    #4c78ff ${btcAngle}deg,
                    #2c334d ${btcAngle}deg,
                    #2c334d 360deg
                )`;

                // Fetch top 100 coins to approximate Alt Season Index
                const topCoinsData = await fetchWithRetry(
                    'https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?limit=100',
                    3,
                    2000,
                    { headers }
                );
                const coins = topCoinsData.data;
                const btcData = coins.find(coin => coin.symbol === 'BTC');
                const btcChange24h = btcData.quote.USD.percent_change_24h;

                // Filter out stablecoins and wrapped tokens (basic approximation)
                const altcoins = coins.filter(coin => 
                    !['USDT', 'USDC', 'DAI', 'WBTC', 'STETH'].includes(coin.symbol) && coin.symbol !== 'BTC'
                );
                const outperformingAltcoins = altcoins.filter(
                    coin => coin.quote.USD.percent_change_24h > btcChange24h
                ).length;
                const altSeasonIndex = Math.round((outperformingAltcoins / altcoins.length) * 100);
                document.getElementById('alt-season-value').textContent = `${altSeasonIndex}%`;
                const altAngle = (altSeasonIndex / 100) * 360;
                document.getElementById('alt-season-circle').style.background = `conic-gradient(
                    #ff5277 0deg,
                    #4c78ff ${altAngle}deg,
                    #2c334d ${altAngle}deg,
                    #2c334d 360deg
                )`;

                // Fetch price data for display
                const priceList = document.getElementById('price-list');
                priceList.innerHTML = '';
                coins.slice(0, 50).forEach(coin => {
                    const price = coin.quote.USD.price.toFixed(coin.symbol === 'BTC' ? 2 : 6);
                    const change24h = coin.quote.USD.percent_change_24h || 0;
                    const priceColorClass = change24h >= 0 ? 'green' : 'red';
                    const priceItem = document.createElement('div');
                    priceItem.className = 'price-item';
                    priceItem.innerHTML = `
                        <img src="https://s2.coinmarketcap.com/static/img/coins/64x64/${coin.id}.png" alt="${coin.name} icon" loading="lazy">
                        <div class="coin-info">
                            <span>${coin.name} (${coin.symbol})</span>
                            <span class="price ${priceColorClass}">$${price} (${change24h.toFixed(2)}%)</span>
                        </div>
                    `;
                    priceList.appendChild(priceItem);
                });

            } catch (error) {
                console.error('Error in fetchData:', error.message);
                document.getElementById('fear-greed-value').textContent = 'N/A';
                document.getElementById('btc-dominance-value').textContent = 'N/A';
                document.getElementById('alt-season-value').textContent = 'N/A';
                document.getElementById('fear-greed-classification').textContent = 'მონაცემები მიუწვდომელია';
                document.getElementById('price-list').innerHTML = '<p>ფასების ჩატვირთვა ვერ მოხერხდა</p>';
            }
        }

        fetchData();
        setInterval(fetchData, 300000); // Every 5 minutes
    </script>
</body>
</html>
